'use strict';

var fs = require('fs');

var log = require('gulplog');
var stdout = require('mute-stdout');

var taskTree = require('gulp-cli/lib/versioned/^3.7.0/task-tree');
var copyTree = require('gulp-cli/lib/shared/log/copy-tree');

var tildify = require('gulp-cli/lib/shared/tildify');
var logTasks = require('gulp-cli/lib/shared/log/tasks');
var ansi = require('gulp-cli/lib/shared/ansi');
var logEvents = require('gulp-cli/lib/versioned/^3.7.0/log/events');
var logTasksSimple = require('gulp-cli/lib/versioned/^3.7.0/log/tasks-simple');
var registerExports = require('gulp-cli/lib/shared/register-exports');

function execute(opts, env, config) {
  var tasks = opts._;
  var toRun = tasks.length ? tasks : ['default'];

  if (opts.tasksSimple || opts.tasks || opts.tasksJson) {
    // Mute stdout if we are listing tasks
    stdout.mute();
  }

  // This is what actually loads up the gulpfile
  var exported = require(env.configPath);
  log.info('Using gulpfile', ansi.magenta(tildify(env.configPath)));

  var gulpInst = require(env.modulePath);
  logEvents(gulpInst);

  registerExports(gulpInst, exported);

  // Always unmute stdout after gulpfile is required
  stdout.unmute();

  process.nextTick(function() {
    var tree;

    if (opts.tasksSimple) {
      return logTasksSimple(env, gulpInst);
    }
    if (opts.tasks) {
      tree = taskTree(gulpInst.tasks);
      if (config.description && typeof config.description === 'string') {
        tree.label = config.description;
      } else {
        tree.label = 'Tasks for ' + ansi.magenta(tildify(env.configPath));
      }
      return logTasks(tree, opts, function(task) {
        return gulpInst.tasks[task].fn;
      });
    }
    if (opts.tasksJson) {
      tree = taskTree(gulpInst.tasks);
      if (config.description && typeof config.description === 'string') {
        tree.label = config.description;
      } else {
        tree.label = 'Tasks for ' + tildify(env.configPath);
      }

      var output = JSON.stringify(copyTree(tree, opts));

      if (typeof opts.tasksJson === 'boolean') {
        return console.log(output);
      }

      return fs.writeFileSync(opts.tasksJson, output, 'utf-8');
    }
    gulpInst.start.apply(gulpInst, toRun);
  });
}

module.exports = execute;
